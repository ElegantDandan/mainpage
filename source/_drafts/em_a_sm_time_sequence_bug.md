title: 记一个低功耗模式下Debug的神奇经历
description: 
date: 
layout: post
categories:
- 嵌入式软件
---

四个小时解决了一个蛋疼的bug 觉得还挺有意思的所以记录一下
这个问题比较具体 但是反映了执行时序对状态机程序的一种影响吧 

---

Bug描述
===========

在公司做的一个项目
硬件情况: freesale家的Ks16(嗯现在是NXP家) Cortex-M0+核
程序处于开发阶段 使用串口打印调试(115200bps) 
输出信息很多所以分了从0到7的几个调试等级 设置输出调试等级越低时输出的信息越多比如Lv0时能看到所有调试信息, 等级划分类似:
```
Lv0   硬件抽象层相关
Lv1   计算细节/状态转换消息投递相关
Lv2   时序相关信息
...
```
为了开发过程中方便调试 一直把低功耗相关特性屏蔽着 现在已经完成功能调试 所以把低功耗特性打开了 问题也随之浮出水面
Bug是这样的: ``使能低功耗特性, 调试等级开到Lv2以上, 状态机程序卡死在一个状态中, 没有继续执行; 而关闭低功耗特性后, 各调试等级功能正常``


Bug分析及程序细节描述
======================

很明显 Bug与调试打印输出对时序的影响 以及低功耗特性有关 
串口调试打印输出使用的是阻塞式 等待数据发完程序才继续执行 这种调试方式会影响程序时序 因为工作在115200bps下 1字节数据需要0.08ms 随便输出点信息就是相当于一个毫秒级的延时操作了
然而光凭现象 完全没法猜到问题所在 下面来细细描述出问题的这部分程序

首先 关于低功耗模式
----------------------
低功耗模式

(todo:)



Bug定位过程
===============
一开始只是发现打开低功耗特性后 Release版没法工作, 而Debug开低调试等级时就能工作


